"use strict";angular.module("landingApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/welcome.html",controller:"WelcomeCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("landingApp").controller("RootCtrl",["$scope","$rootScope","$timeout","$interval","$location","$sce","$http","Donations","Users",function(a,b,c,d,e,f,g,h,i){function j(){p=!0;var a=b.goBack();if(p=!1,a)throw"ignore"}function k(){0==b.online&&(b.online=!0,!b.user&&b.user_id?(console.log("No user but user_id cookie is found - fetching from DB"),c(function(){b.getUser()})):b.user_id||(console.log("No user_id cookies found - redirecting to welcome screen",localStorage),localStorage.setItem("returnUrl",e.path()),e.path("/welcome")))}function l(){b.online=!1}function m(){g.get(Consts.api_root+"ping").success(function(){d.cancel(q),k()}).error(function(){l()})}function n(){document.addEventListener("backbutton",j,!1),document.addEventListener("online",k,!1),document.addEventListener("offline",l,!1),initPushNotifications()}function o(){a.canAnimate=!0,b.windowHeight=$(window).height(),b.windowWidth=$(window).width(),b.containerWidth=$(".container").width(),b.picHeight=.6*$(".container").width(),document.addEventListener("deviceready",n,!1),FastClick.attach(document.body),c(function(){window.scrollTo(0,1)},1e3)}console.log("APP VERSION: 1.0"),b.isWeb=$(window).width()>700,b.isIphone=navigator.userAgent.indexOf("iPhone")>0,console.log("Getting data from cookies",localStorage),b.fb_id=localStorage.fb_id,b.user_id=localStorage.user_id,b.user_pet_id=localStorage.user_pet_id,b.trustSrc=function(a){return f.trustAsResourceUrl(a)},b.reloadApp=function(){top.location.reload()},b.getUser=function(){i.query({id:b.user_id},function(c){c._id?(console.log("Found user in DB",c),b.user=c,a.$broadcast("userIsFetched"),b.user&&b.user._id&&(localStorage.user_id=b.user._id,console.log("Saving user_id cookie",b.user._id,localStorage.user_id)),b.user&&b.user.pet&&b.user.pet._id&&(localStorage.user_pet_id=b.user.pet._id,console.log("Saving user_pet_id cookie",b.user.pet._id,localStorage.user_pet_id))):(console.log("No user in DB - redirecting to welcome screen",localStorage),localStorage.clear(),localStorage.setItem("returnUrl",e.path()),e.path("/welcome"))},function(){console.log("DB failure - redirecting to welcome screen",localStorage),e.path("/welcome")})},b.showDialog=function(b){a.dialogShown=!0,c(function(){a.$broadcast("showTipDialog",b),a.$emit("showTipDialog",b)},0)},b.showDialogIfNeeded=function(a){"undefined"==typeof localStorage[a+"-dialog-shown"]&&(localStorage[a+"-dialog-shown"]="shown",b.showDialog(a))},b.closeDialog=function(b){a.dialogShown=!1,c(function(){a.$broadcast("closeTipDialog",b),a.$emit("closeTipDialog",b)},0)},b.fbShare=function(){return a.showDialog("share-disabled"),!0},b.runAnimation=function(a,b,e,f,g){$(a).css("background-size",f*e+"px auto");var h=e,i=0,j=d(function(){return 0==h&&angular.isFunction(g)?(d.cancel(j),c(function(){g()}),void c(function(){$(a).css("background-position-x",0)},1e3)):($(a).css("background-position-x",-1*i),h--,void(i+=f))},b/e)},b.goto=function(a){0==a.indexOf("http")?window.open(a+"#phonegap=external","_system"):0==a.indexOf("#")?location.href=a:e.path(a)},a.history=[],a.lastUrl="",b.currentPage="",b.currentPet="";var p=!1;b.getBackPage=function(){var c="";switch(b.currentPage){case"shop":c="pet/"+a.currentPet;break;case"adopted":c="pets/adopted";break;case"lonely":c="pets/lonely";break;default:return!1}return c},a.shouldCloseApp=!1,b.goBack=function(){if(a.cartIsUp||a.pushMenuOpen||a.dialogShown)return a.cartIsUp=!1,b.closePushMenu(),b.closeDialog(),!0;var d=b.getBackPage();return d?(c.cancel(a.cancelBack),c(function(){a.goingBack=!0,c(function(){e.path(d)},0)},0),a.cancelBack=c(function(){a.goingBack=!1},5e3),!0):p?!1:(b.openPushMenu(),p&&(a.shouldCloseApp=!0),!0)},a.pushMenuOpen=!1,b.openPushMenu=function(){a.pushMenuOpen||($("body").addClass("pushed"),$("#menuRight").addClass("cbp-spmenu-open"),a.pushMenuOpen=!0)},b.closePushMenu=function(){a.pushMenuOpen&&($("body").removeClass("pushed"),$("#menuRight").removeClass("cbp-spmenu-open"),a.pushMenuOpen=!1)},b.$on("$routeUpdate",function(){e.search().dialog||b.closeDialog()}),a.$on("$stateChangeStart",function(c,d,e){console.log("Start changing route from: "+e+" to: "+d),a.cartIsUp=!1,b.closePushMenu(),b.closeDialog()}),a.$on("$stateChangeSuccess",function(a,b,c){console.log("Changed route from: "+c+" to: "+b)}),a.logoAnimationComplete=!1,a.animateSplashScreen=function(){b.runAnimation(".not-online-logo-animation",1700,48,266,function(){c(function(){a.logoAnimationComplete=!0,b.notOnlineAnimationCompleted=!0},1e3)})},m(),l();var q=d(function(){m()},5e3);c(function(){a.animateSplashScreen()},0),window.handlePushRegistration=function(b,c){var d=i.update({_id:a.user_id,platform:b,push_token:c});console.log("Update push data",d)},c(function(){o()},5)}]),angular.module("landingApp").controller("WelcomeCtrl",["$scope","$rootScope","$timeout","$interval","$location","Users",function(a,b,c,d,e,f){function g(a){if(console.log("storeUserAndRedirect called",a),"undefined"!=typeof a&&a&&a._id){localStorage.setItem("user_id",a._id),b.user_id=localStorage.user_id,console.log("saved user_id",localStorage.user_id,a._id),b.user=a,console.log("saved user to root scope",b.user,a),a.pet&&(localStorage.setItem("user_pet_id",a.pet._id),b.user_pet_id=localStorage.user_pet_id,console.log("saved user_pet_id",localStorage.user_pet_id,a.pet._id));var d=localStorage.returnUrl;d&&console.log("got return url from local storage",d),c(function(){d&&"/welcome"!=d?(localStorage.setItem("returnUrl",""),console.log("Redirecting to return url",d),e.path(d)):(console.log("Redirecting to /"),e.path("/"))},500)}}console.log("WelcomeCtrl"),b.bodyClass="welcome",b.bodyBg="welcome",a.placeLogo=function(d){"undefined"==typeof d&&(d=5),c(function(){$(".welcome-app-explained").length>0&&(b.windowHeight=$(window).height(),b.windowWidth=$(window).width(),a.logoSpace=parseInt(b.windowHeight-$(".bottom-wrapper").height())-20,a.logoHeight=parseInt(a.logoSpace-80>370?370:a.logoSpace-80),a.logoWidth=parseInt(a.logoHeight/370*266),a.logoHeight=370*a.logoWidth/266,a.logoMargin=parseInt((a.logoSpace-a.logoHeight)/2),a.logoSpacePX=a.logoSpace+"px",a.logoHeightPX=a.logoHeight+"px",a.logoMarginPX=a.logoMargin+"px auto",a.logoWidthPX=a.logoWidth+"px"),d>0&&c(function(){a.placeLogo(d-1)},1e3)})},a.fbLogin=function(){a.online&&facebookConnectPlugin.login(["email"],function(a){console.log("FB login responded",a),a.authResponse?facebookConnectPlugin.api("/me",["email"],function(a){console.log("fetched /me data from facebook - creating user",a);var b=a.id;localStorage.setItem("fb_id",b),console.log("saved fb_id",localStorage.fb_id,a.id),f.create({fb_id:b,name:a.name,email:a.email,image:"https://graph.facebook.com/"+b+"/picture"},function(a){console.log("user created",a),g(a)})}):console.log("User cancelled login or did not fully authorize.")})},c(function(){facebookConnectPlugin.getLoginStatus(function(a){if(console.log("Auto response arrived from facebook",a),console.log("the user is logged in and has authenticated your app",a.authResponse),"connected"===a.status){var c=b.user;c?(console.log("User found in scope",b.user),g(c)):facebookConnectPlugin.api("/me",["email"],function(a){console.log("fetched /me data from facebook - creating user",a);var b=a.id;localStorage.setItem("fb_id",b),f.create({fb_id:b,name:a.name,email:a.email,image:"https://graph.facebook.com/"+b+"/picture"},function(a){console.log("user created",a),g(a)})})}else"not_authorized"===a.status?(console.log("the user is logged in to Facebook, but has not authenticated your app"),localStorage.fb_id=void 0,localStorage.user_id=void 0,localStorage.user_pet_id=void 0):console.log("the user isnt logged in to Facebook")})},500),window.debug=a}]);